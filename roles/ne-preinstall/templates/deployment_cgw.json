[
  {
    "op": "add",
    "path": "/spec/template/spec",
	  "value": {
      "initContainers": [
        {
          "name": "iptables-init",
          "image": "harbor.nexr.kr/istio/proxyv2:1.8.4",
          "command": [
            "sh",
            "-c",
            "iptables -t raw -A PREROUTING -s ${INGRESS_GW_IP} -j ACCEPT -m comment --comment 'iptables-exporter ingress gateway in traffic';\niptables -t raw -A PREROUTING -s ${POD_IP_CIDR} -j ACCEPT -m comment --comment 'iptables-exporter internal (pod) in traffic';\niptables -t raw -A PREROUTING -s ${CLUSTER_IP_CIDR} -j ACCEPT -m comment --comment 'iptables-exporter internal (svc) in traffic';\niptables -t raw -A PREROUTING -j ACCEPT -m comment --comment 'iptables-exporter external in traffic';\n\niptables -t raw -A OUTPUT -d ${INGRESS_GW_IP} -j ACCEPT -m comment --comment 'iptables-exporter ingress gateway out traffic';\niptables -t raw -A OUTPUT -d ${POD_IP_CIDR} -j ACCEPT -m comment --comment 'iptables-exporter internal (pod) out traffic';\niptables -t raw -A OUTPUT -d ${CLUSTER_IP_CIDR} -j ACCEPT -m comment --comment 'iptables-exporter internal (svc) out traffic';\niptables -t raw -A OUTPUT -j ACCEPT -m comment --comment 'iptables-exporter external out traffic'\n"
          ],
          "env": [
            {
              "name": "POD_IP_CIDR",
              "value": "172.31.0.0/16"
            },
            {
              "name": "CLUSTER_IP_CIDR",
              "value": "10.96.0.0/12"
            },
            {
              "name": "INGRESS_GW_IP",
              "value": "172.31.108.97"
            }
          ],
          "resources": {},
          "terminationMessagePath": "/dev/termination-log",
          "terminationMessagePolicy": "File",
          "imagePullPolicy": "IfNotPresent",
          "securityContext": {
            "capabilities": {
              "add": [
                "NET_ADMIN",
                "NET_RAW"
              ],
              "drop": [
                "ALL"
              ]
            },
            "privileged": false,
            "allowPrivilegeEscalation": false
          }
        }
      ],
      "containers": [
        {
          "name": "cgw",
          "image": "harbor.nexr.kr/nexr-enterprise/cgw-server-web:1.3.2",
          "ports": [
            {
              "name": "http",
              "containerPort": 8190,
              "protocol": "TCP"
            }
          ],
          "envFrom": [
            {
              "configMapRef": {
                "name": "cgw-config"
              }
            }
          ],
          "env": [
            {
              "name": "POD_NAME",
              "valueFrom": {
                "fieldRef": {
                  "apiVersion": "v1",
                  "fieldPath": "metadata.name"
                }
              }
            },
            {
              "name": "POD_NAMESPACE",
              "valueFrom": {
                "fieldRef": {
                  "apiVersion": "v1",
                  "fieldPath": "metadata.namespace"
                }
              }
            }
          ],
          "resources": {
            "limits": {
              "cpu": "1",
              "memory": "1Gi"
            },
            "requests": {
              "cpu": "1",
              "memory": "1Gi"
            }
          },
          "volumeMounts": [
            {
              "name": "default-token-ng8md",
              "readOnly": true,
              "mountPath": "/var/run/secrets/kubernetes.io/serviceaccount"
            }
          ],
          "livenessProbe": {
            "httpGet": {
              "path": "/actuator/health/ping",
              "port": "http",
              "scheme": "HTTP"
            },
            "timeoutSeconds": 1,
            "periodSeconds": 30,
            "successThreshold": 1,
            "failureThreshold": 3
          },
          "readinessProbe": {
            "httpGet": {
              "path": "/actuator/health/ping",
              "port": "http",
              "scheme": "HTTP"
            },
            "initialDelaySeconds": 30,
            "timeoutSeconds": 1,
            "periodSeconds": 30,
            "successThreshold": 1,
            "failureThreshold": 3
          },
          "terminationMessagePath": "/dev/termination-log",
          "terminationMessagePolicy": "File",
          "imagePullPolicy": "IfNotPresent",
          "securityContext": {}
        },
        {
          "name": "nginx",
          "image": "harbor.nexr.kr/library/nginx:1.19",
          "command": [
            "sleep",
            "12345678"
          ],
          "resources": {},
          "terminationMessagePath": "/dev/termination-log",
          "terminationMessagePolicy": "File",
          "imagePullPolicy": "IfNotPresent"
        },
        {
          "name": "iptables-exporter",
          "image": "harbor.nexr.kr/madron/iptables-exporter:latest",
          "command": [
            "iptables-exporter",
            "--port",
            "9090",
            "--ip-version",
            "4",
            "--tables",
            "raw"
          ],
          "ports": [
            {
              "containerPort": 9090,
              "protocol": "TCP"
            }
          ],
          "resources": {},
          "terminationMessagePath": "/dev/termination-log",
          "terminationMessagePolicy": "File",
          "imagePullPolicy": "IfNotPresent",
          "securityContext": {
            "capabilities": {
              "add": [
                "NET_ADMIN",
                "NET_RAW"
              ],
              "drop": [
                "ALL"
              ]
            },
            "privileged": false,
            "allowPrivilegeEscalation": false
          }
        }
      ]
    }
  }
]
